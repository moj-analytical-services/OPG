2024-06-03 12:25:45,555 - *** Hello from supervision_clients_caseflow.py ***
2024-06-03 12:25:52,511 - pydbtools: Last glue export date seems to be 2024-06-03
2024-06-03 12:25:52,513 - pydbtools: looking for contemporary glue exports of 7 tables ...
2024-06-03 12:25:58,834 - pydbtools: using 'supervision_level_log' table glue export from 2024-06-03 in Sirius
2024-06-03 12:26:08,499 - pydbtools: using 'cases' table glue export from 2024-06-03 in Sirius
2024-06-03 12:26:22,112 - pydbtools: using 'persons' table glue export from 2024-06-03 in Sirius
2024-06-03 12:26:28,582 - pydbtools: using 'death_notifications' table glue export from 2024-06-03 in Sirius
2024-06-03 12:26:32,862 - pydbtools: using 'fee_reduction' table glue export from 2024-06-03 in Sirius
2024-06-03 12:26:37,297 - pydbtools: using 'finance_client' table glue export from 2024-06-03 in Sirius
2024-06-03 12:26:44,611 - pydbtools: using 'addresses' table glue export from 2024-06-03 in Sirius
2024-06-03 12:26:44,613 - pydbtools: our SQL query is: 'with active_fee_reductions AS ( SELECT fp.client_id, SUBSTRING(fre.type, 1, 1) || LOWER(SUBSTRING(fre.type, 2)) AS discounttype, fre.startdate AS startdate, fre.enddate AS enddate, fp.payment_method FROM opg_sirius_prod.fee_reduction fre INNER JOIN opg_sirius_prod.finance_client fp ON fp.id = fre.finance_client_id AND fp.glueexporteddate = DATE('2024-06-03') INNER JOIN ( SELECT MAX(fr.id) AS id, fr.finance_client_id FROM opg_sirius_prod.fee_reduction fr WHERE fr.enddate >= current_date AND fr.startdate <= current_date AND fr.deleted = FALSE AND fr.glueexporteddate = DATE('2024-06-03') GROUP BY fr.finance_client_id ) ids ON ids.id = fre.id WHERE fre.glueexporteddate = DATE('2024-06-03') ), earliest_orderdate AS ( SELECT MIN(c.orderdate) as orderdate, c.client_id FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') GROUP BY c.client_id ), earliest_receiptdate AS ( SELECT MIN(c.receiptdate) as receiptdate, c.client_id FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') AND c.receiptdate IS NOT NULL GROUP BY c.client_id ), regain AS ( SELECT c.client_id, c.statusdate FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') AND c.orderclosurereason = 'CLIENT REGAINED CAPACITY' ), order_list AS ( SELECT c.client_id as client_id, c.caserecnumber as court_number, ARRAY_AGG(c.id) AS order_ids, ARRAY_AGG(c.casesubtype) AS order_types, ARRAY_AGG(CAST(c.orderdate AS varchar)) AS order_made_dates, ARRAY_AGG(CAST(c.orderissuedate AS varchar)) AS order_issue_dates, ARRAY_AGG(CAST(c.orderexpirydate AS varchar)) AS order_expiry_dates, ARRAY_AGG(c.orderclosurereason) AS order_closure_reason, ARRAY_AGG(c.orderstatus) AS order_statuses, ARRAY_AGG(CAST(c.statusdate AS varchar)) AS order_status_dates FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') AND c.casetype = 'ORDER' GROUP BY c.client_id, c.caserecnumber ) SELECT c.caserecnumber AS court_number, p.id AS client_id, p.firstname AS client_forename, p.surname AS client_surname, p.dob AS client_dob, p.clientaccommodation AS client_accommodation, p.maritalstatus AS client_maritalstatus, p.clientstatus AS client_status, CASE WHEN p.dateofdeath IS NOT NULL THEN p.dateofdeath WHEN p.clientstatus != 'ACTIVE' AND rc.statusdate IS NOT NULL THEN rc.statusdate WHEN p.dateofdeath IS NULL AND dn.datenotified IS NOT NULL THEN dn.datenotified ELSE NULL END AS termination_date, p.dateofdeath AS client_date_of_death, a.postcode AS client_postcode, p.risk_score AS CREC, dep.deputytype AS feepayer_deputy_type, eo.orderdate AS earliest_order_made_date, CAST(er.receiptdate AS DATE) AS earliest_receipt_date, afr.discounttype AS feereductiontype, afr.startdate AS awardstartdate, afr.enddate AS awardenddate, c.id as order_id, c.casesubtype as order_type, c.orderstatus as order_status, level.supervisionlevel as case_sup_level, level.assetlevel as assets_level, c.orderdate as order_made_date, c.orderissuedate as order_issue_date, c.orderexpirydate as order_expiry_date, c.orderclosurereason as order_closure_reason, CAST(c.statusdate AS varchar) as order_status_date FROM opg_sirius_prod.persons p LEFT JOIN opg_sirius_prod.addresses a on p.id = a.person_id AND a.glueexporteddate = DATE('2024-06-03') LEFT JOIN opg_sirius_prod.persons dep ON dep.id = p.feepayer_id AND dep.glueexporteddate = DATE('2024-06-03') LEFT JOIN opg_sirius_prod.death_notifications dn on dn.person_id = p.id AND dn.glueexporteddate = DATE('2024-06-03') LEFT JOIN active_fee_reductions afr ON afr.client_id = p.id LEFT JOIN earliest_orderdate eo ON eo.client_id = p.id LEFT JOIN earliest_receiptdate er ON er.client_id = p.id LEFT JOIN regain rc ON rc.client_id = p.id LEFT JOIN opg_sirius_prod.cases c ON p.id = c.client_id AND c.glueexporteddate = DATE('2024-06-03') AND lower(c.type) = 'order' LEFT JOIN ( SELECT mr.order_id, MAX(mr.createddate) mostrecent FROM opg_sirius_prod.supervision_level_log mr WHERE mr.glueexporteddate = DATE('2024-06-03') and mr.supervisionlevel is not null GROUP BY mr.order_id ) mostrecents ON c.id = mostrecents.order_id LEFT JOIN opg_sirius_prod.supervision_level_log level ON mostrecents.order_id = level.order_id AND mostrecents.mostrecent = level.createddate AND level.glueexporteddate = DATE('2024-06-03') WHERE p.glueexporteddate = DATE('2024-06-03') AND p.type = 'actor_client' ORDER BY c.caserecnumber, c.orderdate ASC'
2024-06-03 12:28:04,231 - *** Hello from supervision_clients_caseflow.py ***
2024-06-03 12:28:10,520 - pydbtools: Last glue export date seems to be 2024-06-03
2024-06-03 12:28:10,522 - pydbtools: looking for contemporary glue exports of 7 tables ...
2024-06-03 12:28:16,937 - pydbtools: using 'supervision_level_log' table glue export from 2024-06-03 in Sirius
2024-06-03 12:28:23,221 - pydbtools: using 'cases' table glue export from 2024-06-03 in Sirius
2024-06-03 12:28:30,487 - pydbtools: using 'persons' table glue export from 2024-06-03 in Sirius
2024-06-03 12:28:35,855 - pydbtools: using 'death_notifications' table glue export from 2024-06-03 in Sirius
2024-06-03 12:28:40,103 - pydbtools: using 'fee_reduction' table glue export from 2024-06-03 in Sirius
2024-06-03 12:28:45,480 - pydbtools: using 'finance_client' table glue export from 2024-06-03 in Sirius
2024-06-03 12:28:53,835 - pydbtools: using 'addresses' table glue export from 2024-06-03 in Sirius
2024-06-03 12:28:53,837 - pydbtools: our SQL query is: 'with active_fee_reductions AS ( SELECT fp.client_id, SUBSTRING(fre.type, 1, 1) || LOWER(SUBSTRING(fre.type, 2)) AS discounttype, fre.startdate AS startdate, fre.enddate AS enddate, fp.payment_method FROM opg_sirius_prod.fee_reduction fre INNER JOIN opg_sirius_prod.finance_client fp ON fp.id = fre.finance_client_id AND fp.glueexporteddate = DATE('2024-06-03') INNER JOIN ( SELECT MAX(fr.id) AS id, fr.finance_client_id FROM opg_sirius_prod.fee_reduction fr WHERE fr.enddate >= current_date AND fr.startdate <= current_date AND fr.deleted = FALSE AND fr.glueexporteddate = DATE('2024-06-03') GROUP BY fr.finance_client_id ) ids ON ids.id = fre.id WHERE fre.glueexporteddate = DATE('2024-06-03') ), earliest_orderdate AS ( SELECT MIN(c.orderdate) as orderdate, c.client_id FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') GROUP BY c.client_id ), earliest_receiptdate AS ( SELECT MIN(c.receiptdate) as receiptdate, c.client_id FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') AND c.receiptdate IS NOT NULL GROUP BY c.client_id ), regain AS ( SELECT c.client_id, c.statusdate FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') AND c.orderclosurereason = 'CLIENT REGAINED CAPACITY' ), order_list AS ( SELECT c.client_id as client_id, c.caserecnumber as court_number, ARRAY_AGG(c.id) AS order_ids, ARRAY_AGG(c.casesubtype) AS order_types, ARRAY_AGG(CAST(c.orderdate AS varchar)) AS order_made_dates, ARRAY_AGG(CAST(c.orderissuedate AS varchar)) AS order_issue_dates, ARRAY_AGG(CAST(c.orderexpirydate AS varchar)) AS order_expiry_dates, ARRAY_AGG(c.orderclosurereason) AS order_closure_reason, ARRAY_AGG(c.orderstatus) AS order_statuses, ARRAY_AGG(CAST(c.statusdate AS varchar)) AS order_status_dates FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') AND c.casetype = 'ORDER' GROUP BY c.client_id, c.caserecnumber ) SELECT c.caserecnumber AS court_number, p.id AS client_id, p.firstname AS client_forename, p.surname AS client_surname, p.dob AS client_dob, p.clientaccommodation AS client_accommodation, p.maritalstatus AS client_maritalstatus, p.clientstatus AS client_status, CASE WHEN p.dateofdeath IS NOT NULL THEN p.dateofdeath WHEN p.clientstatus != 'ACTIVE' AND rc.statusdate IS NOT NULL THEN rc.statusdate WHEN p.dateofdeath IS NULL AND dn.datenotified IS NOT NULL THEN dn.datenotified ELSE NULL END AS termination_date, p.dateofdeath AS client_date_of_death, a.postcode AS client_postcode, p.risk_score AS CREC, dep.deputytype AS feepayer_deputy_type, eo.orderdate AS earliest_order_made_date, CAST(er.receiptdate AS DATE) AS earliest_receipt_date, afr.discounttype AS feereductiontype, afr.startdate AS awardstartdate, afr.enddate AS awardenddate, c.id as order_id, c.casesubtype as order_type, c.orderstatus as order_status, level.supervisionlevel as case_sup_level, level.assetlevel as assets_level, c.orderdate as order_made_date, c.orderissuedate as order_issue_date, c.orderexpirydate as order_expiry_date, c.orderclosurereason as order_closure_reason, CAST(c.statusdate AS varchar) as order_status_date FROM opg_sirius_prod.persons p LEFT JOIN opg_sirius_prod.addresses a on p.id = a.person_id AND a.glueexporteddate = DATE('2024-06-03') LEFT JOIN opg_sirius_prod.persons dep ON dep.id = p.feepayer_id AND dep.glueexporteddate = DATE('2024-06-03') LEFT JOIN opg_sirius_prod.death_notifications dn on dn.person_id = p.id AND dn.glueexporteddate = DATE('2024-06-03') LEFT JOIN active_fee_reductions afr ON afr.client_id = p.id LEFT JOIN earliest_orderdate eo ON eo.client_id = p.id LEFT JOIN earliest_receiptdate er ON er.client_id = p.id LEFT JOIN regain rc ON rc.client_id = p.id LEFT JOIN opg_sirius_prod.cases c ON p.id = c.client_id AND c.glueexporteddate = DATE('2024-06-03') AND lower(c.type) = 'order' LEFT JOIN ( SELECT mr.order_id, MAX(mr.createddate) mostrecent FROM opg_sirius_prod.supervision_level_log mr WHERE mr.glueexporteddate = DATE('2024-06-03') and mr.supervisionlevel is not null GROUP BY mr.order_id ) mostrecents ON c.id = mostrecents.order_id LEFT JOIN opg_sirius_prod.supervision_level_log level ON mostrecents.order_id = level.order_id AND mostrecents.mostrecent = level.createddate AND level.glueexporteddate = DATE('2024-06-03') WHERE p.glueexporteddate = DATE('2024-06-03') AND p.type = 'actor_client' ORDER BY c.caserecnumber, c.orderdate ASC'
2024-06-03 12:29:47,361 - *** Hello from supervision_clients_caseflow.py ***
2024-06-03 12:29:53,709 - pydbtools: Last glue export date seems to be 2024-06-03
2024-06-03 12:29:53,712 - pydbtools: looking for contemporary glue exports of 7 tables ...
2024-06-03 12:30:00,147 - pydbtools: using 'supervision_level_log' table glue export from 2024-06-03 in Sirius
2024-06-03 12:30:06,531 - pydbtools: using 'cases' table glue export from 2024-06-03 in Sirius
2024-06-03 12:30:14,009 - pydbtools: using 'persons' table glue export from 2024-06-03 in Sirius
2024-06-03 12:30:20,342 - pydbtools: using 'death_notifications' table glue export from 2024-06-03 in Sirius
2024-06-03 12:30:26,640 - pydbtools: using 'fee_reduction' table glue export from 2024-06-03 in Sirius
2024-06-03 12:30:31,985 - pydbtools: using 'finance_client' table glue export from 2024-06-03 in Sirius
2024-06-03 12:30:39,312 - pydbtools: using 'addresses' table glue export from 2024-06-03 in Sirius
2024-06-03 12:30:39,316 - pydbtools: our SQL query is: 'with active_fee_reductions AS ( SELECT fp.client_id, SUBSTRING(fre.type, 1, 1) || LOWER(SUBSTRING(fre.type, 2)) AS discounttype, fre.startdate AS startdate, fre.enddate AS enddate, fp.payment_method FROM opg_sirius_prod.fee_reduction fre INNER JOIN opg_sirius_prod.finance_client fp ON fp.id = fre.finance_client_id AND fp.glueexporteddate = DATE('2024-06-03') INNER JOIN ( SELECT MAX(fr.id) AS id, fr.finance_client_id FROM opg_sirius_prod.fee_reduction fr WHERE fr.enddate >= current_date AND fr.startdate <= current_date AND fr.deleted = FALSE AND fr.glueexporteddate = DATE('2024-06-03') GROUP BY fr.finance_client_id ) ids ON ids.id = fre.id WHERE fre.glueexporteddate = DATE('2024-06-03') ), earliest_orderdate AS ( SELECT MIN(c.orderdate) as orderdate, c.client_id FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') GROUP BY c.client_id ), earliest_receiptdate AS ( SELECT MIN(c.receiptdate) as receiptdate, c.client_id FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') AND c.receiptdate IS NOT NULL GROUP BY c.client_id ), regain AS ( SELECT c.client_id, c.statusdate FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') AND c.orderclosurereason = 'CLIENT REGAINED CAPACITY' ), order_list AS ( SELECT c.client_id as client_id, c.caserecnumber as court_number, ARRAY_AGG(c.id) AS order_ids, ARRAY_AGG(c.casesubtype) AS order_types, ARRAY_AGG(CAST(c.orderdate AS varchar)) AS order_made_dates, ARRAY_AGG(CAST(c.orderissuedate AS varchar)) AS order_issue_dates, ARRAY_AGG(CAST(c.orderexpirydate AS varchar)) AS order_expiry_dates, ARRAY_AGG(c.orderclosurereason) AS order_closure_reason, ARRAY_AGG(c.orderstatus) AS order_statuses, ARRAY_AGG(CAST(c.statusdate AS varchar)) AS order_status_dates FROM opg_sirius_prod.cases c WHERE c.glueexporteddate = DATE('2024-06-03') AND c.casetype = 'ORDER' GROUP BY c.client_id, c.caserecnumber ) SELECT c.caserecnumber AS court_number, p.id AS client_id, p.firstname AS client_forename, p.surname AS client_surname, p.dob AS client_dob, p.clientaccommodation AS client_accommodation, p.maritalstatus AS client_maritalstatus, p.clientstatus AS client_status, CASE WHEN p.dateofdeath IS NOT NULL THEN p.dateofdeath WHEN p.clientstatus != 'ACTIVE' AND rc.statusdate IS NOT NULL THEN rc.statusdate WHEN p.dateofdeath IS NULL AND dn.datenotified IS NOT NULL THEN dn.datenotified ELSE NULL END AS termination_date, p.dateofdeath AS client_date_of_death, a.postcode AS client_postcode, p.risk_score AS CREC, dep.deputytype AS feepayer_deputy_type, eo.orderdate AS earliest_order_made_date, CAST(er.receiptdate AS DATE) AS earliest_receipt_date, afr.discounttype AS feereductiontype, afr.startdate AS awardstartdate, afr.enddate AS awardenddate, c.id as order_id, c.casesubtype as order_type, c.orderstatus as order_status, level.supervisionlevel as case_sup_level, level.assetlevel as assets_level, c.orderdate as order_made_date, c.orderissuedate as order_issue_date, c.orderexpirydate as order_expiry_date, c.orderclosurereason as order_closure_reason, CAST(c.statusdate AS varchar) as order_status_date FROM opg_sirius_prod.persons p LEFT JOIN opg_sirius_prod.addresses a on p.id = a.person_id AND a.glueexporteddate = DATE('2024-06-03') LEFT JOIN opg_sirius_prod.persons dep ON dep.id = p.feepayer_id AND dep.glueexporteddate = DATE('2024-06-03') LEFT JOIN opg_sirius_prod.death_notifications dn on dn.person_id = p.id AND dn.glueexporteddate = DATE('2024-06-03') LEFT JOIN active_fee_reductions afr ON afr.client_id = p.id LEFT JOIN earliest_orderdate eo ON eo.client_id = p.id LEFT JOIN earliest_receiptdate er ON er.client_id = p.id LEFT JOIN regain rc ON rc.client_id = p.id LEFT JOIN opg_sirius_prod.cases c ON p.id = c.client_id AND c.glueexporteddate = DATE('2024-06-03') AND lower(c.type) = 'order' LEFT JOIN ( SELECT mr.order_id, MAX(mr.createddate) mostrecent FROM opg_sirius_prod.supervision_level_log mr WHERE mr.glueexporteddate = DATE('2024-06-03') and mr.supervisionlevel is not null GROUP BY mr.order_id ) mostrecents ON c.id = mostrecents.order_id LEFT JOIN opg_sirius_prod.supervision_level_log level ON mostrecents.order_id = level.order_id AND mostrecents.mostrecent = level.createddate AND level.glueexporteddate = DATE('2024-06-03') WHERE p.glueexporteddate = DATE('2024-06-03') AND p.type = 'actor_client' ORDER BY c.caserecnumber, c.orderdate ASC'
2024-06-03 12:42:38,006 - Uploaded report to Supervisions/caseflow/supervision_clients_caseflow_20240603.xlsx
2024-06-03 12:42:38,011 - Uploading logfile to Supervisions/caseflow/logs/supervision_clients_caseflow_20240603.log
